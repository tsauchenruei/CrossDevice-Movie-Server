<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿é–“ç®¡ç† - é›»å½±æ’­æ”¾ä¼ºæœå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #333 0%, #555 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        
        .create-room {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .room-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-player {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-control {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .room-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.2s ease;
        }
        
        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .room-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .room-id {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .room-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-playing { background: #4CAF50; }
        .status-paused { background: #ff9800; }
        .status-idle { background: #ccc; }
        
        .room-body {
            padding: 15px;
        }
        
        .room-info {
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .info-label {
            color: #666;
        }
        
        .info-value {
            font-weight: 500;
            color: #333;
        }
        
        .room-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .stats-bar {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1000;
        }
        
        .connected { background: #4CAF50; color: white; }
        .disconnected { background: #f44336; color: white; }
        .loading { background: #ff9800; color: white; }
        
        @media (max-width: 768px) {
            .rooms-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status loading" id="connectionStatus">
        ğŸ”„ é€£æ¥ä¸­...
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ  æˆ¿é–“ç®¡ç†ä¸­å¿ƒ</h1>
            <p class="subtitle">ç®¡ç†å¤šå€‹æ’­æ”¾æœƒè©±ï¼Œæ”¯æ´ A-Bã€C-D ç­‰å¤šçµ„é…å°</p>
        </div>
        
        <div class="content">
            <!-- çµ±è¨ˆä¿¡æ¯ -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number" id="totalRooms">0</div>
                    <div class="stat-label">æ´»èºæˆ¿é–“</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalClients">0</div>
                    <div class="stat-label">é€£æ¥å®¢æˆ¶ç«¯</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="playingRooms">0</div>
                    <div class="stat-label">æ’­æ”¾ä¸­</div>
                </div>
            </div>
            
            <!-- å‰µå»ºæˆ¿é–“ -->
            <div class="section">
                <h2 class="section-title">ğŸ†• å‰µå»ºæ–°æˆ¿é–“</h2>
                <div class="create-room">
                    <div class="input-group">
                        <input type="text" class="room-input" id="roomNameInput" 
                               placeholder="è¼¸å…¥æˆ¿é–“åç¨±ï¼ˆä¾‹å¦‚ï¼šå®¢å»³ã€è‡¥å®¤ã€æœƒè­°å®¤Aï¼‰" maxlength="20">
                        <button class="btn btn-success" id="createRoomBtn">å‰µå»ºæˆ¿é–“</button>
                    </div>
                    <p style="color: #666; font-size: 0.9rem;">
                        ğŸ’¡ æç¤ºï¼šæ¯å€‹æˆ¿é–“éƒ½æœ‰ç¨ç«‹çš„æ’­æ”¾ç‹€æ…‹ï¼Œæ”¯æ´å¤šçµ„è¨­å‚™åŒæ™‚ä½¿ç”¨
                    </p>
                </div>
            </div>
            
            <!-- æˆ¿é–“åˆ—è¡¨ -->
            <div class="section">
                <h2 class="section-title">ğŸ¡ ç¾æœ‰æˆ¿é–“</h2>
                <div class="rooms-grid" id="roomsContainer">
                    <div class="empty-state">
                        <h3>ğŸ”„ è¼‰å…¥æˆ¿é–“ä¸­...</h3>
                        <p>è«‹ç¨å€™ï¼Œæ­£åœ¨ç²å–æˆ¿é–“åˆ—è¡¨</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // WebSocket é€£æ¥
        const socket = io();
        
        // DOM å…ƒç´ 
        const connectionStatus = document.getElementById('connectionStatus');
        const roomsContainer = document.getElementById('roomsContainer');
        const roomNameInput = document.getElementById('roomNameInput');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const totalRooms = document.getElementById('totalRooms');
        const totalClients = document.getElementById('totalClients');
        const playingRooms = document.getElementById('playingRooms');
        
        let rooms = [];
        
        // é€£æ¥ç‹€æ…‹è™•ç†
        socket.on('connect', () => {
            connectionStatus.textContent = 'ğŸŸ¢ å·²é€£æ¥';
            connectionStatus.className = 'connection-status connected';
            loadRooms();
            console.log('å·²é€£æ¥åˆ°ä¼ºæœå™¨');
        });
        
        socket.on('disconnect', () => {
            connectionStatus.textContent = 'ğŸ”´ é€£æ¥ä¸­æ–·';
            connectionStatus.className = 'connection-status disconnected';
            console.log('èˆ‡ä¼ºæœå™¨é€£æ¥ä¸­æ–·');
        });
        
        // æˆ¿é–“æ›´æ–°äº‹ä»¶
        socket.on('rooms_update', () => {
            loadRooms();
        });
        
        // è¼‰å…¥æˆ¿é–“åˆ—è¡¨
        async function loadRooms() {
            try {
                const response = await fetch('/api/rooms');
                const data = await response.json();
                rooms = data.rooms || [];
                
                updateStats(data);
                renderRooms();
            } catch (error) {
                console.error('è¼‰å…¥æˆ¿é–“å¤±æ•—:', error);
                roomsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>âŒ è¼‰å…¥å¤±æ•—</h3>
                        <p>ç„¡æ³•è¼‰å…¥æˆ¿é–“åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥</p>
                    </div>
                `;
            }
        }
        
        // æ›´æ–°çµ±è¨ˆä¿¡æ¯
        function updateStats(data) {
            totalRooms.textContent = data.rooms.length;
            totalClients.textContent = data.total_clients;
            playingRooms.textContent = data.rooms.filter(room => room.is_playing).length;
        }
        
        // æ¸²æŸ“æˆ¿é–“åˆ—è¡¨
        function renderRooms() {
            if (rooms.length === 0) {
                roomsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ  æš«ç„¡æˆ¿é–“</h3>
                        <p>å‰µå»ºç¬¬ä¸€å€‹æˆ¿é–“é–‹å§‹ä½¿ç”¨</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            rooms.forEach(room => {
                const statusClass = room.is_playing ? 'status-playing' : 
                                  (room.current_movie ? 'status-paused' : 'status-idle');
                const statusText = room.is_playing ? 'æ’­æ”¾ä¸­' : 
                                 (room.current_movie ? 'å·²æš«åœ' : 'å¾…æ©Ÿä¸­');
                
                const currentContent = room.current_movie ? 
                    `${room.current_movie} - ${room.current_episode}` : 'ç„¡å…§å®¹';
                
                html += `
                    <div class="room-card">
                        <div class="room-header">
                            <div class="room-id">${room.id}</div>
                            <div class="room-status">
                                <span class="status-indicator ${statusClass}"></span>
                                ${statusText}
                            </div>
                        </div>
                        <div class="room-body">
                            <div class="room-info">
                                <div class="info-item">
                                    <span class="info-label">ç•¶å‰å…§å®¹:</span>
                                    <span class="info-value">${currentContent}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æ’­æ”¾å™¨:</span>
                                    <span class="info-value">${room.players_count} å€‹</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æ§åˆ¶å°:</span>
                                    <span class="info-value">${room.controllers_count} å€‹</span>
                                </div>
                            </div>
                            <div class="room-actions">
                                <button class="btn btn-player" onclick="joinRoom('${room.id}', 'player')">
                                    ğŸ“º æ’­æ”¾å™¨
                                </button>
                                <button class="btn btn-control" onclick="joinRoom('${room.id}', 'controller')">
                                    ğŸ® æ§åˆ¶å°
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            roomsContainer.innerHTML = html;
        }
        
        // å‰µå»ºæˆ¿é–“
        function createRoom() {
            const roomName = roomNameInput.value.trim();
            if (!roomName) {
                alert('è«‹è¼¸å…¥æˆ¿é–“åç¨±');
                return;
            }
            
            if (rooms.some(room => room.id === roomName)) {
                alert('æˆ¿é–“åç¨±å·²å­˜åœ¨ï¼Œè«‹é¸æ“‡å…¶ä»–åç¨±');
                return;
            }
            
            // å‰µå»ºæˆ¿é–“ï¼ˆé€šéåŠ å…¥ä¸€å€‹æ–°æˆ¿é–“ä¾†å‰µå»ºï¼‰
            joinRoom(roomName, 'temp');
            roomNameInput.value = '';
        }
        
        // åŠ å…¥æˆ¿é–“
        function joinRoom(roomId, type) {
            if (type === 'player') {
                window.open(`/player/${roomId}`, '_blank');
            } else if (type === 'controller') {
                window.open(`/control/${roomId}`, '_blank');
            } else if (type === 'temp') {
                // è‡¨æ™‚åŠ å…¥ä»¥å‰µå»ºæˆ¿é–“ï¼Œç„¶å¾Œç«‹å³é›¢é–‹
                socket.emit('join_room', {room: roomId, type: 'temp'});
                setTimeout(() => {
                    socket.emit('leave_room', {room: roomId});
                }, 100);
            }
        }
        
        // äº‹ä»¶ç›£è½
        createRoomBtn.addEventListener('click', createRoom);
        roomNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createRoom();
            }
        });
        
        // å®šæœŸæ›´æ–°æˆ¿é–“åˆ—è¡¨
        setInterval(loadRooms, 10000); // æ¯10ç§’æ›´æ–°ä¸€æ¬¡
        
        console.log('æˆ¿é–“ç®¡ç†é é¢å·²åˆå§‹åŒ–');
    </script>
</body>
</html>